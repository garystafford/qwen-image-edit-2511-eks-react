# JSON patch for DaemonSet: cache full base model for 4-bit bitsandbytes quantization
# Downloads from S3 in HF cache format (blobs/refs/snapshots)
# Uses variant-specific marker file to avoid conflicts with other model variants
# Note: Same full base model as 8-bit — only the quantization at load time differs
- op: replace
  path: /spec/template/spec/nodeSelector
  value:
    nvidia.com/gpu.present: "true"
    workload: "qwen"
- op: replace
  path: /spec/template/spec/initContainers/0/args
  value:
    - |
      set -e

      MODEL_DIR="/host-models/qwen-image-edit-2511-full"
      MARKER_FILE="/host-models/.model-ready-4bit-bnb"
      # S3_BUCKET comes from environment variable
      S3_PREFIX="qwen-image-edit-2511-full"

      echo "=== Qwen Model Cache DaemonSet (4-bit bitsandbytes) ==="
      echo "Node: $(hostname)"
      echo "Model directory: ${MODEL_DIR}"

      # Check if model already exists on this node
      if [ -f "${MARKER_FILE}" ]; then
        echo "✓ Model already cached on this node"
        exit 0
      fi

      echo "Model not found, downloading from S3..."
      echo "S3 location: s3://${S3_BUCKET}/${S3_PREFIX}/"
      echo "Note: Full base model is ~103 GB, download may take several minutes"

      # Create directory
      mkdir -p "${MODEL_DIR}"

      # Download from S3 to node-local storage
      echo "Starting download..."
      time aws s3 sync \
        "s3://${S3_BUCKET}/${S3_PREFIX}/" \
        "${MODEL_DIR}/" \
        --region ${AWS_REGION} \
        --no-progress

      # Set permissions for appuser (UID 1000)
      echo "Setting permissions for appuser..."
      chown -R 1000:1000 /host-models
      chmod -R 755 /host-models

      # Create marker file
      echo "$(date)" > "${MARKER_FILE}"

      echo "✓ Model cached successfully to node-local EBS"
      echo "✓ Future pods on this node will use cached model"
